<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daily LSTM - Backtest Matrix</title>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    :root { --text-color: #2c3e50; }
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; color: var(--text-color); background-color: #f5f6fa; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #000 0%, #1a1a1a 100%); padding: 25px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px); }
    .header-content { max-width: 1400px; margin: 0 auto; padding: 0 30px; display: flex; justify-content: space-between; align-items: center; }
    .header-title { font-family: "Porsche Next", "Segoe UI", Arial, sans-serif; font-size: 28px; font-weight: 300; letter-spacing: 1px; color: #fff; margin: 0; }
    .header-meta { color: #fff; opacity: 0.85; font-size: 14px; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; overflow: hidden; }
    .card-header { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 18px 22px; border-bottom: 1px solid rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:space-between; }
    .card-title { font-family: "Porsche Next", "Segoe UI", Arial, sans-serif; font-size: 22px; font-weight: 300; color: #000; margin: 0; letter-spacing: 0.3px; }
    .controls { display:flex; gap:12px; align-items:center; }
    .controls input, .controls select, .controls button { padding: 8px 10px; border-radius: 6px; border: 1px solid #d0d7de; background:#fff; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; padding: 16px 22px; }
    @media(min-width: 1100px){ .grid { grid-template-columns: 1fr 1fr; } }
    table.matrix { width: 100%; border-collapse: collapse; }
    table.matrix th, table.matrix td { border: 1px solid #e5e7eb; padding: 10px 12px; text-align: center; }
    table.matrix thead th { background: #000; color: #fff; font-weight: 400; }
    .pill { display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; }
    .pill.win { background:#e6f4ea; color:#137333; }
    .pill.loss { background:#fce8e6; color:#a50e0e; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1 class="header-title">Daily LSTM — Backtest Matrix</h1>
      <div class="header-meta" id="headerMeta">Loading…</div>
    </div>
  </div>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Controls</h2>
        <div class="controls">
          <label for="dateSelect">Date</label>
          <select id="dateSelect"></select>
          <input id="dateInput" placeholder="YYYYMMDD" pattern="\\d{8}" />
          <button id="loadBtn">Load</button>
        </div>
      </div>
      <div class="grid">
        <div>
          <h3 style="margin:8px 0 10px 0; font-weight:500;">MECE Matrix</h3>
          <table class="matrix" id="matrixTable">
            <thead>
              <tr>
                <th>F10/C1 bin \\ Sentiment</th>
                <th>Missing (win/loss)</th>
                <th>&lt;0.1 (win/loss)</th>
                <th>&gt;=0.1 (win/loss)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <h3 style="margin:8px 0 10px 0; font-weight:500;">Invest Block (0–2% &amp; sentiment ≥0.1)</h3>
          <div id="investBlock">Loading…</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><h2 class="card-title">F10/C1 in 0–2% &amp; Sentiment ≥0.1</h2></div>
      <div style="padding: 16px 22px;">
        <table id="tbl_0_2" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Symbol</th><th>Win/Loss</th><th>A1 T-1</th><th>A1 T</th><th>Ret %</th><th>F10/C1 %</th><th>Sent 7d</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header"><h2 class="card-title">F10/C1 &lt; 0% &amp; Sentiment ≥0.1</h2></div>
      <div style="padding: 16px 22px;">
        <table id="tbl_lt0" class="display" style="width:100%">
          <thead>
            <tr>
              <th>Symbol</th><th>Win/Loss</th><th>A1 T-1</th><th>A1 T</th><th>Ret %</th><th>F10/C1 %</th><th>Sent 7d</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>

  <script>
    function fmtPct(v){ return (v === null || v === undefined) ? '' : (v).toFixed(2) + '%'; }
    function fmtNum(v){ return (v === null || v === undefined) ? '' : Number(v).toFixed(2); }
    function businessPrev(yyyymmdd){
      const y = yyyymmdd.substring(0,4), m = yyyymmdd.substring(4,6), d = yyyymmdd.substring(6,8);
      const dt = new Date(Number(y), Number(m)-1, Number(d));
      do { dt.setDate(dt.getDate()-1); } while (dt.getDay() === 0 || dt.getDay() === 6);
      const mm = String(dt.getMonth()+1).padStart(2,'0');
      const dd = String(dt.getDate()).padStart(2,'0');
      return `${dt.getFullYear()}${mm}${dd}`;
    }

    async function loadMeta(){
      const res = await fetch(`../App/data/meta.json?v=${Date.now()}`);
      const meta = await res.json();
      const latest = meta.latest_date;
      const prev = businessPrev(latest);
      const sel = document.getElementById('dateSelect');
      sel.innerHTML = '';
      [latest, prev].forEach(d => {
        const opt = document.createElement('option'); opt.value = d; opt.textContent = d; sel.appendChild(opt);
      });
      document.getElementById('headerMeta').textContent = `Latest: ${latest}`;
      return latest;
    }

    function renderMatrix(matrix){
      const rows = ['<0','0-2','>2'];
      const tbody = document.querySelector('#matrixTable tbody');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const m = matrix[r]['Missing'];
        const a = matrix[r]['<0.1'];
        const b = matrix[r]['>=0.1'];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="text-align:left">${r}</td>
          <td>${m.win}/${m.loss}</td>
          <td>${a.win}/${a.loss}</td>
          <td>${b.win}/${b.loss}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderInvestBlock(invest){
      const el = document.getElementById('investBlock');
      el.innerHTML = `Stocks: <strong>${invest.stocks}</strong><br/>P&L win: $${invest.pnl_win.toFixed(2)}<br/>P&L loss: $${invest.pnl_loss.toFixed(2)}`;
    }

    function renderTable(tableId, rows){
      const data = rows.map(r => [
        r.symbol,
        r.win ? '<span class="pill win">win</span>' : '<span class="pill loss">loss</span>',
        fmtNum(r.a1_prev),
        fmtNum(r.a1_T),
        fmtPct(r.ret_pct),
        fmtPct(r.f10_over_c1_pct),
        (r.sentiment_7d === undefined || r.sentiment_7d === null) ? '' : r.sentiment_7d.toFixed(2)
      ]);
      const existing = $(`#${tableId}`).DataTable();
      if (existing) { existing.destroy(); }
      $(`#${tableId}`).DataTable({ data, columns: [
        { title:'Symbol' }, { title:'Win/Loss' }, { title:'A1 T-1' }, { title:'A1 T' }, { title:'Ret %' }, { title:'F10/C1 %' }, { title:'Sent 7d' }
      ], pageLength: 25, order:[[0,'asc']]});
    }

    async function loadDate(date){
      const res = await fetch(`../App/data/backtest_${date}.json?v=${Date.now()}`);
      if (!res.ok){
        alert(`No backtest JSON for ${date}. Generate it first.`);
        return;
      }
      const js = await res.json();
      renderMatrix(js.matrix);
      renderInvestBlock(js.invest_block);
      renderTable('tbl_0_2', js.candidates.f10c1_0_2_and_sent_ge_0_1);
      renderTable('tbl_lt0', js.candidates.f10c1_lt_0_and_sent_ge_0_1);
    }

    (async function init(){
      const latest = await loadMeta();
      $('#dateSelect').val(latest);
      $('#loadBtn').on('click', () => {
        const typed = ($('#dateInput').val() || '').trim();
        const d = typed.match(/^\d{8}$/) ? typed : $('#dateSelect').val();
        loadDate(d);
      });
      // autoload latest
      loadDate(latest);
    })();
  </script>
</body>
</html>


